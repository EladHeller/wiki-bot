AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: Wiki Bot Serverless Application

Parameters:
  BucketCodeName:
    Description: The name of code bucket.
    Type: String
  WikiUserName:
    Description: The name of wiki user.
    Type: String
  WikiPassword:
    Description: The password of wiki user.
    Type: String
  WikiProtectUserName:
    Description: The name of wiki protect user.
    Type: String
  WikiProtectPassword:
    Description: The password of wiki protect user.
    Type: String
  WikiDeleteUserName:
    Description: The name of wiki delete user.
    Type: String
  WikiDeletePassword:
    Description: The password of wiki delete user.
    Type: String
  ImageVersion:
    Description: Trick for force deploy
    Type: String
  DistCodeVersionId:
    Type: String
  OpenAPIKey:
    Type: String
  VectorStoreID:
    Type: String

Globals:
  Function:
    Runtime: nodejs24.x
    Timeout: 900
    MemorySize: 1024
    CodeUri:
      Bucket: !Ref BucketCodeName
      Key: dist.zip
      Version: !Ref DistCodeVersionId
    Environment:
      Variables:
        USER_NAME: !Ref WikiUserName
        PASSWORD: !Ref WikiPassword

Resources:
  MarketValueFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: Market-value-function
      Handler: dist/marketValue/index.main
      Timeout: 900
      MemorySize: 2048
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 19 ? * * *)
            Name: Market-value-scheduler

  UsStocksFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: US-stocks-function
      Handler: dist/usMarketValue/index.main
      Timeout: 360
      MemorySize: 2048
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 22 ? * * *)
            Name: US-stocks-scheduler

  KineretLevelFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: Kineret-level-function
      Handler: dist/kineret/index.main
      Timeout: 20
      MemorySize: 512
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 5,10,15,20 ? * * *)
            Name: Kineret-level-scheduler

  PurgeBirthdayFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: purge-birthday-function
      Handler: dist/purge.main
      Timeout: 21
      MemorySize: 512
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 0 ? * * *)
            Name: purge-birthday-scheduler

  ProtectTemplatesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: protect-templates-function
      Handler: dist/admin/protect.main
      Environment:
        Variables:
          USER_NAME: !Ref WikiProtectUserName
          PASSWORD: !Ref WikiProtectPassword
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 6,18 ? * * *)
            Name: protect-templates-scheduler

  DeleteRedirectsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: delete-redirects-function
      Handler: dist/admin/deleteRedirects.main
      Environment:
        Variables:
          USER_NAME: !Ref WikiDeleteUserName
          PASSWORD: !Ref WikiDeletePassword
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 6,18 ? * * *)
            Name: delete-redirects-scheduler

  CopyrightViolationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: copyright-violation-function
      Handler: dist/maintenance/copyrightViolation.main
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 6,18 ? * * *)
            Name: copyright-violation-scheduler

  ArchiveLogsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: archive-logs-function
      Handler: dist/maintenance/archiveBot/index.main
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 8 5,6,8 * ? *)
            Name: archive-logs-scheduler

  ArchiveClosedDiscussionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: archive-closed-discussions-function
      Handler: dist/maintenance/closedDiscussionsArchiveBot/index.main
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 7 ? * 1-5,7 *)
            Name: archive-closed-discussions-scheduler

  ArchiveUserTalkFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: archive-user-talk-function
      Handler: dist/maintenance/userTalkArchiveBot/index.main
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 8 ? * 1-6 *)
            Name: archive-user-talk-scheduler

  RunScriptsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: run-scripts-function
      Handler: dist/experiments/lambda.main

  IndexesBotFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: indexes-function
      Handler: dist/indexesBot/index.main
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 18 ? * * *)
            Name: indexes-bot-scheduler

  RecordChartsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: record-charts-function
      Handler: dist/recordCharts/index.main
      Timeout: 120
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 18 ? * * *)
            Name: record-charts-scheduler

  IronSwordsFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  IronSwordsFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: iron-swords-function-new
      PackageType: Image
      Role: !GetAtt IronSwordsFunctionRole.Arn
      Code:
        ImageUri: !Sub ${AWS::AccountId}.dkr.ecr.us-east-1.amazonaws.com/wiki-bot-playwright:${ImageVersion}
      Timeout: 900
      MemorySize: 2048
      Environment:
        Variables:
          USER_NAME: !Ref WikiUserName
          PASSWORD: !Ref WikiPassword
      EphemeralStorage:
        Size: 2048

  IronSwordsEventRule:
    Type: AWS::Events::Rule
    Properties:
      Name: iron-swords-scheduler
      ScheduleExpression: cron(0 18 ? * * *)
      Targets:
        - Id: iron-swords-function-new
          Arn: !GetAtt IronSwordsFunction.Arn

  IronSwordsInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt IronSwordsEventRule.Arn
      FunctionName: iron-swords-function-new

  TagBotFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: tag-bot-function
      Handler: dist/tag-bot/index.main
      Environment:
        Variables:
          USER_NAME: !Ref WikiUserName
          PASSWORD: !Ref WikiPassword
          OPENAI_API_KEY: !Ref OpenAPIKey
          VECTOR_STORE_ID: !Ref VectorStoreID
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 18 ? * 7 *)
            Name: tag-bot-scheduler
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt TagBotQueue.Arn
            BatchSize: 1

  TagBotQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: tag-bot-queue
      VisibilityTimeout: 900

  DraftsOnWrongCategoriesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: drafts-on-wrong-categories-function
      Handler: dist/maintenance/removeDraftsFromCategories/index.main
      Timeout: 900
      MemorySize: 2048
      EphemeralStorage:
        Size: 2048
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 7 ? * 1 *)
            Name: drafts-on-wrong-categories-scheduler

  SportPersonalityTemplatesYearsFormatFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: sport-personality-templates-years-format-function
      Handler: dist/sportPersonalityTemplatesYearsFormat/index.main
      Timeout: 900
      MemorySize: 2048
      EphemeralStorage:
        Size: 2048
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 7 ? * 1#1 *)
            Name: sport-personality-templates-years-format-scheduler

  ExchangeRatesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: exchange-rates-function
      Handler: dist/exchangeRates/index.main
      Timeout: 30
      MemorySize: 512
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: cron(0,30 14,15,16,17,18 ? * * *)
            Name: exchange-rates-scheduler
