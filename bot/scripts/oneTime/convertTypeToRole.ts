import { promiseSequence } from '../../utilities';
import { findTemplates, getTemplateKeyValueData, templateFromKeyValueData } from '../../wiki/newTemplateParser';
import WikiApi from '../../wiki/WikiApi';

const articles = [
  "זאב ז'בוטינסקי",
  'אהוד ברק',
  'רפאל איתן',
  'חיים הרצוג',
  'משה דיין',
  'עזר ויצמן',
  'שארל דה גול',
  'ויליאם בליי',
  'יעקב דורי',
  'דליה דורנר',
  'יגאל אלון',
  'מרדכי גור',
  'יובל נאמן',
  'הרמן גרינג',
  'יגאל ידין',
  'מרדכי מקלף',
  'בנימין בן אליעזר',
  "ג'יימס גרפילד",
  'חיים לסקוב',
  'צבי צור',
  'איזי דורות',
  'נחמן שי',
  'שאול מופז',
  "ג'ון ורקר, ויקונט גורט השישי",
  'דוד אלעזר',
  'משה לוי',
  'דן שומרון',
  'אמנון ליפקין-שחק',
  'משה יעלון',
  "גאורגי ז'וקוב",
  'יעקב טרנר',
  'שלמה להט',
  'פאול פון הינדנבורג',
  'ארתור ולסלי, הדוכס הראשון מוולינגטון',
  'לואי מאונטבאטן',
  'אפרים סנה',
  'אוליבר קרומוול',
  'גדעון עזרא',
  "צ'סטר ארתור",
  'עמרם מצנע',
  'אביגדור קהלני',
  'רון חולדאי',
  'מתן וילנאי',
  'אנרי פיליפ פטן',
  "צ'יאנג קאי שק",
  'אבי דיכטר',
  'איסר הראל',
  'צבי זמיר',
  'יעקב פרי',
  'יובל דיסקין',
  'מאיר דגן',
  'דני חלוץ',
  'יצחק מרדכי',
  'עמי אילון',
  'כרמי גילון',
  'הרברט פלומר',
  'עמוס מנור',
  'ויליאם, נסיך ויילס',
  'ארתור ווקופ',
  'דני יתום',
  'הרצל בודינגר',
  'מירי רגב',
  'קרל הארבעה עשר, מלך שוודיה',
  'אריה אלדד',
  'רון כתרי',
  'משה קראדי',
  'יון אנטונסקו',
  'אהרן רמז',
  'אהוד יתום',
  'אודי שני',
  'פרבז מושארף',
  'דורון אלמוג',
  'דוד קראוס',
  'שלמה אהרונישקי',
  'דוד צור',
  'אלעזר שטרן',
  'בני גנץ',
  'ישראל וייס',
  'אברהם יפה',
  'מתי פלד',
  'מאיר שמגר',
  'עוזי דיין',
  'יוסף הרמלין',
  'מאיר זורע',
  'יהושע שגיא',
  'אביחי רונצקי',
  'אליעזר כהן',
  'יצחק בן ישראל',
  'סטלה לוי',
  'עמירה דותן',
  'רפי איתן',
  'אברהם אחיטוב',
  'ישראל חסון',
  'אברהם שלום',
  'רפי פלד',
  'יהודה וילק',
  'גד נבון',
  'מרדכי פירון',
  'ראובן שילוח',
  'מאיר עמית',
  'שבתי שביט',
  'יצחק חופי',
  'אפרים הלוי',
  'אלכסנדר הייג',
  "יצחק אהרונוביץ'",
  'מאיר פעיל',
  'עומר בראדלי',
  'אסף חפץ',
  'אודי אדם',
  'משה כרמל',
  'יואב גלנט',
  'אהרן יריב',
  'גדי איזנקוט',
  'גבי אשכנזי',
  'אמיר אשל',
  'נחום אדמוני',
  "ג'ון מקיין",
  'יונה רוזן',
  'דן הראל',
  'אביחי מנדלבליט',
  'יוסי פלד',
  'אילן בירן',
  'אורי אור',
  'אליהו לנקין',
  'אסעד אסעד',
  'רחבעם זאבי',
  'טל רוסו',
  'אהוד אבריאל',
  'עמר בר-לב',
  'מרדכי צפורי',
  'צבי בר',
  'משה פלד (חבר הכנסת)',
  'אריאל שרון',
  'מיקי לוי',
  'דודי כהן',
  'אליהו מרידור',
  'צבי ענבר',
  'פנחס בוכריס',
  'צבי גנדלמן',
  'יצחק שד"ר',
  'שמואל טולידאנו',
  'מייקל מאלן',
  'מוחמד זיא אל-חאק',
  'מרדכי בר-און',
  'אסתר דומיניסיני',
  'חזי לוי',
  'חנא חדד',
  'חי אדיב',
  'גיורא לב',
  'נחמן אש',
  'רפאל סוויסה',
  "ג'ון ג'ליקו",
  'אורי וולטש',
  'אלעד פלד',
  'דורון אביטל',
  'יאיר גולן',
  'אריה ביבי',
  'יצחק רבין',
  'הרצי הלוי',
  'אביב כוכבי',
  'לודוויג פון באטנברג',
  'איל בן ראובן',
  "הנסיך ג'ורג', דוכס קנט",
  'מרדכי גזית',
  'אילן הררי',
  'אייל זמיר',
  'בנצי סאו',
  'יוחנן דנינו',
  'משה מזרחי (חבר הכנסת)',
  'יואב סגלוביץ',
  'אחמד וחידי',
  'מאיר מיבר',
  "ג'וליאן בינג",
  'אפרים חירם',
  'דוד רשף',
  'קרל הראשון, קיסר אוסטריה',
  'יגאל סלוביק',
  'ברנרד פרגוסון',
  'נמרוד שפר',
  'אורנה ברביבאי',
  'אמנואלה פיליברטו, דוכס אאוסטה',
  'תמיר פרדו',
  'ויליאם סלים',
  'יורם כהן',
  'אמיר ברעם',
  'צבי גוב-ארי',
  'מרטין דמפסי',
  'אריאל עמיעד',
  'אויגן, ארכידוכס אוסטריה',
  'הושע פרידמן בן-שלום',
  "הנסיך ג'ורג', דוכס קיימברידג'",
  'רונן מרלי',
  'עבד אל-פתאח א-סיסי',
  'חסן פירוזאבאדי',
  'מיכאל הרצוג',
  'ארנון אפק',
  'מוטי יוגב',
  'מירלה גל',
  'יוני שטבון',
  'משה אדרי (קצין משטרה)',
  'הנרי וושבורן',
  'יוסי כהן',
  'אייל קרים',
  'אורי מנוס',
  'אבי זהר',
  'הרולד אלכסנדר, רוזן אלכסנדר הראשון מתוניס',
  'פטריס דה מק-מהון',
  'אלברכט, דוכס וירטמברג',
  'וילהלם, נסיך הכתר של גרמניה',
  'דוד זיני',
  'שמואל טולידאנו',
  'הארכידוכס קרל, דוכס טשן',
  'דני שחר',
  'רמי כהן',
  'סיימון פרייזר, לורד לובאט ה-15',
  'מוטי כהן',
  'קובי שבתאי',
  'איתן גולן',
  'שמחה מעוז',
  'רוני מרום',
  'סאלח אל-עארורי',
  "מעד'א חסבאני",
  'בזיל ברוק',
  'מופיד מרעי',
  'אשל ארמוני',
  "ג'ון גורטון",
  'רופרכט, נסיך הכתר של בוואריה',
  'פנחס יחזקאלי',
  'אלי בין',
  "אלכסנדר הור-רות'בן, ארל גאורי הראשון",
  "מייקל ג'פרי",
  'פיטר קוסגרוב',
  'ענת ברקו',
  "ג'ים וב",
  "ג'יימס מאטיס",
  'הרצל בוקר',
  'מרתה מקסאלי',
  'לאופולד, נסיך בוואריה',
  'הארכידוכס פרידריך, דוכס טשן',
  'יוזף פרדיננד, ארכידוכס אוסטריה',
  'יוזף אוגוסט, ארכידוכס אוסטריה',
  'רוני אלשיך',
  'פרידריך קרל, נסיך פרוסיה',
  'אלברט, מלך סקסוניה',
  "ג'רי מטפארה",
  'גאורג, מלך סקסוניה',
  'פרידריך אוגוסט השלישי, מלך סקסוניה',
  'לויד אוסטין',
  'שרון ניר',
  'נדב ארגמן',
  'חגי צוריאל',
  "ויליאם ג'רבויס",
  "צ'ארלס פרגוסון",
  'סיריל ניואול, ברון ניואול הראשון',
  'ברנרד פרייברג, ברון פרייברג הראשון',
  'וילוובי נורי, ברון נורי הראשון',
  'ארתור פוריט, ברון פוריט',
  'ארנולף, נסיך בוואריה',
  "ג'ון קלי",
  'רז שגיא',
  "ג'ק ברגמן",
  "קית' קלוג",
  'רונן מנליס',
  'יחיא סינוואר',
  'הרברט ריימונד מקמאסטר',
  "אמיר עלי חאג'יזאדה",
  'גיליס בילט',
  'רוברט מולר',
  'פרדריק פון אוטר',
  'ארביד לינדמן',
  'הרולד ברוקלף',
  'אוגוסט, נסיך וירטמברג',
  'מאיר בן שבת',
  'וילהלם קרל, דוכס אוראך',
  'אלפרד הראשון, נסיך וינדיש-גרץ',
  'פטר פרדיננד, ארכידוכס אוסטריה',
  'יצחק גזית',
  "רוני ג'קסון",
  "אלכסנדר קיימברידג', רוזן אתלון הראשון",
  "ז'ורז' ואניה",
  'שושי כחלון-כידור',
  "ג'ורג' גאולר",
  'איסכנדר מירזא',
  "יחיא ח'אן",
  'רון פרומר',
  'מתן כהנא',
  "עלי שמח'אני",
  'חוסיין סלאמי',
  'דייוויד הארלי',
  'ישראל גולדנשטיין',
  'יוסף גריף',
  'הנרי דירבורן',
  'פיטר פורטר',
  "ל'רוי פופ ווקר",
  'ויליאם בלקנאפ',
  "ג'יימס מק'פרסון (מזכיר הצי)",
  'הוד בצר',
  'גורדון סאליבן',
  'תומאס וייט',
  "קנת' בריית'ווייט",
  'פואד שוכר',
  'מריל מקפיק',
  'האוול קוב',
  "בנג'מין בריסטו",
  'אן לושאן',
  'לי יואנהונג',
  "אע'א מוחמד ח'אן קאג'אר",
  "באי צ'ונג-שי",
  'פנג דה-חואי',
  'רוברט נייפייר',
  'אגוסטין הראשון, קיסר מקסיקו',
  'ראמה החמישי, מלך תאילנד',
  'לין ביאו',
  'מא בופאנג',
  'רודולף שטגר-שטיינר פון שטיינשטטן',
  'פיליפ שרידן',
  'הנרי האלק',
  'נלסון מיילס',
  'יוסוף אל-עזמה',
  'הנסיך קאנין קוטוהיטו',
  'אלכס דן',
  'אסף צלאל',
  'ולטר ויבר',
  "חה יינג-צ'ין",
  'תומאס פיירפקס',
  'שונרוקו האטא',
  'ארתור פיליפ',
  "ג'ון הנטר",
  "צ'ן צ'נג",
  "יה ג'יין-יינג",
  "הג'ימה סוגיאמה",
  'צאו קון',
  'לכלן מקווארי',
  "תאנום קיטיקצ'ורן",
  'סריט תאנראט',
  'אחמד עלי אל-מאוואווי',
  'קטי פרי',
  'מוחמד נאדיר שאה, מלך אפגניסטן',
  "שיר עלי ח'אן, אמיר אפגניסטן",
  "איוב ח'אן, אמיר אפגניסטן",
  'פזל-אללה זאהדי',
  'פרננדו אלברס דה טולדו, הדוכס השלישי מאלבה',
  'אלסנדרו פארנזה, דוכס פארמה',
  "יאנקו ווקוטיץ'",
  "צ'ארלס דיוונס",
  'הנסיך פרדריק, דוכס יורק ואלבני',
  "ג'פרי אמהרסט, ברון אמהרסט הראשון",
  'פדריקו דה מונטפלטרו, דוכס אורבינו',
  'דני לוי',
  'פלגיוס הראשון, מלך אסטוריאס',
  'נירה שפק',
  'סמואל יאנג',
  'ויליאם וודס',
  'לוציוס למאר',
  'דוד ברנע',
  'לאונרד ווד',
  'איל חולתא',
  'הנסיך ויליאם, דוכס קמברלנד',
  'אייזק שלבי',
  "ז'וזה מנדש קבסאדש",
  'מנואל גומש דה קושטה',
  "ג'ייקוב דולסון קוקס",
  'קארל שורץ',
  'רונן בר',
  'המילטון פיש השלישי',
  'דנקן מקארתור',
  "ג'וזף עאון",
  "ג'ון אדייר",
  "צ'ארלס מרטין",
  "סרהי קורניצ'וק",
  'ויליאם סטון (מושל איווה)',
  'סולימאן עיזאת',
  "ריצ'רד אוגלסבי",
  'גיורא פורדס',
  'שאול כמיסה',
  "ג'וזף דשה",
  'רונן לוי',
  'קונרד בייקר',
  'אלווין פטרסון הובי',
  'קובי יעקובי',
  'ניר ברוך',
  'לואי-אלכסנדר ברתייה',
  'עטאללה סאלחי',
  'עמוס טרטמן',
  'אדוארד אוניל',
  'סרגיי קורוליוב (קצין)',
  'ויליאם אוטס',
  'מוחמד אחמד סאדק',
  'פרנק קפריו',
  'עבאס כאמל',
  "ח'ליל אל-חיה",
  "דושאן סימוביץ'",
  'אברהם אבידן',
  "סיד מקמת'",
  'עבד א-רחים מוסאווי',
  'אמיר חאתמי',
  'סמואל אלברט',
  'צבי בן ארי (מפקד)',
  'עלי מחמוד עבאס',
  'תומאס רוגר',
  "ג'ון בראון גורדון",
  'ירון יצחק בן-נון',
  'מוחמד באקרי',
  "ג'ו פוס",
  "וולטר בדל סמית'",
  "לוציוס פיירצ'יילד",
  'קאדוואלדר וושברן',
  'פילימון דיקינסון',
  'פיליפ סקיילר',
  'תומאס סאמטר',
  'אולין ארל טיג',
  "ג'וליאן לרקום סליי",
  "ויליאם סמית' (מושל וירג'יניה)",
  'הנרי וייז',
  'הנרי ולס',
  "ג'יימס קמפר",
  'פרדריק הולידיי',
  'פיציו לי',
  'עבד אל-כרים מחמוד אבראהים',
  'עלי עבדאללה איוב',
  'ויליאם בייט',
  'חמיד ואחדי',
  'ויליאם פרסטון (פוליטיקאי מקנטקי)',
  "ג'ון בראון (מושל טנסי)",
  'סייף אל-עדל',
  'אדמונד דייוויס',
  'לורנס סאליבן רוס',
  'מוחמד פאכפור',
  'חוסיין מוסאווי',
  "ז'ק ארז",
  'מוחמד כרמי',
  "ג'נאג יואו-שיה",
  'פול אוקטב אבר',
  'הנרי ווטקינס אלן',
  "ג'ון טיילר מורגן",
  'יוסף אל-מדאני',
  'רוברט סטוקטון',
  'אדלברט איימס',
  "אדוארד וולת'ול",
  'אמברוז ברנסייד',
  'ניקולאי האראלמביה',
  'יוסי מקדש',
  'נורמן קייס',
  'ויליאם הנרי ואנדרבילט השלישי',
  "ג'פרי בוסטיק",
];

const typeToServiceMapping: Record<string, string> = {
  משטרה: 'משטרתי',
  שוטר: 'משטרתי',
  משטרתי: 'משטרתי',
  שוטרת: 'משטרתי',
  צבאי: 'צבאי',
  חייל: 'צבאי',
  חיילת: 'צבאי',
  מוסד: 'מוסד',
  'שב"כ': 'שב"כ',
  'מד"א': 'מד"א',
  מחבל: 'טרור',
  מחבלת: 'טרור',
};

const valuesToDelete = new Set([
  'עובד',
  'עובדת',
  'לוחם',
  'לוחמת',
  'סוכן',
  'סוכנת',
  'מרגל',
  'מרגלת',
]);

const TEMPLATE_NAME_LEADER = 'מנהיג';
const TEMPLATE_NAME_OFFICE_HOLDER = 'נושא משרה';
const OLD_FIELD = 'סיווג';
const NEW_FIELD = 'סוג שירות';

type ProcessResult = {
  changed: boolean;
  summary: string[];
  errors: string[];
};

function replaceNestedTemplates(content: string): string {
  return content.replace(/\{\{תפקיד מנהיג/g, '{{תפקיד');
}

function processTemplate(
  template: string,
  templateName: string,
  pageTitle: string,
): { newTemplate: string; result: ProcessResult } {
  const keyValueData = getTemplateKeyValueData(template);
  const result: ProcessResult = { changed: false, summary: [], errors: [] };

  const oldTypeValue = keyValueData[OLD_FIELD];

  if (oldTypeValue !== undefined) {
    const trimmedValue = oldTypeValue.trim();

    if (valuesToDelete.has(trimmedValue)) {
      delete keyValueData[OLD_FIELD];
      result.changed = true;
      result.summary.push(`מחיקת ${OLD_FIELD}=${trimmedValue}`);
    } else if (typeToServiceMapping[trimmedValue]) {
      delete keyValueData[OLD_FIELD];
      keyValueData[NEW_FIELD] = typeToServiceMapping[trimmedValue];
      result.changed = true;
      result.summary.push(`${OLD_FIELD}=${trimmedValue} -> ${NEW_FIELD}=${typeToServiceMapping[trimmedValue]}`);
    } else if (trimmedValue !== '') {
      result.errors.push(`ערך לא ידוע בשדה ${OLD_FIELD}: "${trimmedValue}" בדף ${pageTitle}`);
    }
  }

  const targetTemplateName = templateName === TEMPLATE_NAME_OFFICE_HOLDER
    ? TEMPLATE_NAME_LEADER
    : templateName;

  if (templateName === TEMPLATE_NAME_OFFICE_HOLDER) {
    result.changed = true;
    result.summary.push('שינוי תבנית נושא משרה למנהיג');
  }

  const newTemplate = templateFromKeyValueData(keyValueData, targetTemplateName);

  return { newTemplate, result };
}

export default async function convertTypeToRole() {
  const api = WikiApi();
  await api.login();

  const errors: string[] = [];

  await promiseSequence(10, articles.map((pageTitle) => async () => {
    const { content, revid } = await api.articleContent(pageTitle);
    if (!content) {
      console.error('No content', pageTitle);
      return;
    }

    let newContent = content;
    const summaryParts: string[] = [];

    const templatesByName: Array<{ templates: string[]; name: string }> = [
      { templates: findTemplates(content, TEMPLATE_NAME_OFFICE_HOLDER, pageTitle), name: TEMPLATE_NAME_OFFICE_HOLDER },
      { templates: findTemplates(content, TEMPLATE_NAME_LEADER, pageTitle), name: TEMPLATE_NAME_LEADER },
    ];

    for (const { templates, name } of templatesByName) {
      for (const template of templates) {
        const { newTemplate, result } = processTemplate(template, name, pageTitle);

        if (result.errors.length > 0) {
          errors.push(...result.errors);
          result.errors.forEach((e) => console.error(e));
        }

        if (result.changed) {
          newContent = newContent.replace(template, newTemplate);
          summaryParts.push(...result.summary);
        }
      }
    }

    if (newContent === content) {
      console.log(`No changes needed: ${pageTitle}`);
      return;
    }

    const contentWithReplacedNestedTemplates = replaceNestedTemplates(newContent);
    if (contentWithReplacedNestedTemplates !== newContent) {
      newContent = contentWithReplacedNestedTemplates;
      summaryParts.push('שינוי תפקיד מנהיג לתפקיד');
    }

    if (newContent !== content) {
      const uniqueSummaryParts = Array.from(new Set(summaryParts));
      const summary = `הסבת תבנית מנהיג: ${uniqueSummaryParts.join(', ')} ([[מיוחד:הבדל/42451283|בקשה בוק:בב]]).`;
      await api.edit(pageTitle, summary, newContent, revid);
      console.log(`Updated: ${pageTitle}`);
    } else {
      console.log(`No changes: ${pageTitle}`);
    }
  }));

  if (errors.length > 0) {
    console.log('\n=== Errors Summary ===');
    errors.forEach((e) => console.error(e));
  }

  console.log('\nDone!');
}
