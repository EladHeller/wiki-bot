import { parseStringPromise } from 'xml2js';
import fs from 'fs';
import { findTemplates } from '../bot/wiki/newTemplateParser';

const templates = [
	"בגד",
	"בושם",
	"ויקיפדיה בשפה",
	"מידע עיטור",
	"מלוכה",
	"מעבר גבול",
	"משחק",
	"פארק שעשועים",
	"פרס",
	"צבע",
	"קשרים",
	"אולימפיאדה",
	"אולימפיאדת שחמט",
	"אונייה",
	"אופרה",
	"אחווה",
	"אי",
	"איזוטופ",
	"אירוויזיון",
	"אירוע",
	"אישיות בודהיסטית",
	"אישיות ביטחונית",
	"אישיות בייסבול",
	"אישיות כדורגל",
	"אישיות כדורגל2",
	"אישיות כדוריד",
	"אישיות כדורסל",
	"אישיות משחק",
	"אישיות פוטבול",
	"אישיות רבנית",
	'אישיות תנ"כית',
	"אישיות תקשורת",
	"אל",
	"אלבום",
	"אלגוריתם",
	"אליפות העולם בהוקי קרח",
	"אליפות העולם בשחמט",
	"אמן",
	"אנטומיה",
	"אסון טבע",
	"אסון תחבורה",
	"אצטדיון",
	"ארגון",
	"ארגון פרה-מיליטרי",
	"אתר אינטרנט",
	"אתר ארכאולוגי",
	"בורסה",
	"בית חולים",
	"בית מלון",
	"בית משפט",
	"בית קברות",
	"בנק מרכזי",
	"בעל חיים מפורסם",
	"גאוגרפיה של מדינה",
	"גבול",
	"גוף מים",
	"גוף פלנטרי",
	"גזע",
	"גזע בדיוני",
	"גלקסיה",
	"דמוגרפיה של מדינה",
	"דמות בדיונית",
	"דרגה צבאית",
	"דרך",
	"דתות וזרמים",
	"הורמון",
	"החלטה של האומות המאוחדות",
	"המנון",
	"הסכם",
	"הפלגה",
	"הר",
	"הרכב מחול",
	"ועדה פרלמנטרית",
	"ועידה",
	"זיכיון",
	"חבל ארץ בדיוני",
	"חברה מסחרית",
	"חברה מסחרית/חברת תעופה",
	"חג",
	"חומצת אמינו",
	"חוק",
	"חללית",
	"טייס חלל",
	"טיל",
	"טניסאי",
	"טקס פרסי קולנוע",
	"יבשת",
	"יחידה צבאית",
	"יסוד כימי",
	"יצירה מוזיקלית",
	"יצירת אמנות",
	"כוכב",
	"כלי נגינה",
	"כלי רכב",
	"כלכלת מדינה",
	"ליגה",
	"מאבק אזרחי",
	"מאכל",
	"מבנה",
	"מבנה צבאי",
	"מגלה ארצות",
	"מגפה",
	"מדינה",
	"מדינה באירוויזיון",
	"מדינה במלחמה",
	"מדען",
	"מוזיקאי",
	"מוזיקה",
	"מוסד לימודי",
	"מושב פרלמנט",
	"מזהה",
	"מחזה",
	"מחלה",
	"מחלף",
	"מחנה ריכוז",
	"מחשב",
	"מטבע",
	"מטוס",
	"מידע דגל",
	"מידע סמל",
	"מידע קונסולת משחקים",
	"מינרל",
	"ממצא ארכאולוגי",
	"מנהיג",
	"מנהיג/שושלת",
	"מנוע רקטי",
	"מעבד",
	"מעבד גרפי",
	"מעיין",
	"מערה",
	"מערכת הפעלה",
	"מפל מים",
	"מפלגה",
	"מצפה כוכבים",
	"מרגל",
	"מרוץ אופניים",
	"מרכז זואולוגי",
	"משאל עם",
	"משגר",
	"משחק ספורט",
	"משימת חלל",
	"משפחת שפות",
	"משפט מתמטי",
	"משפטן",
	"משקה",
	"משרה",
	"מתאבק",
	"מתקן שעשועים",
	"נאום",
	"נבחרת הוקי קרח לאומית",
	"נבחרת טניס",
	"נבחרת לאומית",
	"נהג מרוצים",
	"נהר",
	"ניב משפטי",
	"נמל",
	"נציגות דיפלומטית",
	'נק"ל',
	"סגנון אדריכלות",
	"סוג קובץ",
	"סוכנות ממשלתית",
	"סופר",
	"סורה",
	"סיבוב הופעות",
	"סיומת אינטרנט",
	"סינגל",
	"סירה",
	"סכסוך צבאי",
	"סכר",
	"סלע",
	"ספורטאי",
	"ספר",
	'ספר תנ"כי',
	"ספר/מהדורה",
	"ספרייה",
	"סרט",
	"עונה בספורט המוטורי",
	"עונה של מועדון כדורגל",
	"עונת KHL",
	"עונת MLB",
	"עונת NBA",
	"עיר",
	"עיתון",
	"עמק",
	"ערוץ",
	"פארק",
	"פדרציית ספורט",
	"פיגוע טרור",
	"פילוסוף",
	"פסטיבל",
	"פסק דין",
	"פעיל ניו מדיה",
	"פרוטוקול תקשורת",
	"פרלמנט",
	"פרק טלוויזיה",
	"פתיחת שחמט",
	"צבא",
	"צופן בלוקים",
	"ציוד צבאי",
	"צינור",
	"קבוצה אתנית",
	"קבוצת אופניים",
	"קבוצת בייסבול",
	"קבוצת הוקי קרח",
	"קבוצת כדורגל",
	"קבוצת כדוריד",
	"קבוצת כדורמים",
	"קבוצת כדורסל",
	"קבוצת כדורעף",
	"קבוצת פוטבול",
	"קבוצת פורמולה 1",
	"קבוצת רוגבי",
	"קבינט",
	"קבר",
	"קדוש נוצרי",
	"קו רכבת",
	"קומיקס",
	"קוקטייל",
	"קרוסאובר בדיוני",
	"קרחון",
	"רוכב אופנוע",
	"רוכב אופניים",
	"רופא",
	"רכב חלל",
	'רק"ם',
	"שבט צופים תנועת נוער",
	"שדה נפט",
	"שדה תעופה",
	"שושלת",
	"שחמטאי",
	"שכונה",
	"שף",
	"שפה",
	"שפת תכנות",
	"תבנית מידע/אתר מורשת",
	"תוכנה",
	"תוכנית טלוויזיה",
	"תזמורת",
	"תחנת חלל",
	"תחנת רדיו",
	"תחנת רכבת",
	"תחרות אולימפית",
	"תחרות כדורגל",
	"תחרות כדורסל",
	"תחרות ספורט",
	"תמונה להחלפה",
	"תמונות קולאז'",
	"תנועת נוער",
	"תערובת",
	"תערוכה",
	"תקופה",
	"תקיפה צבאית",
	"תרופה",
	"תרכובת",
	"אישיות",
	"חסיד אומות העולם",
	"משתמש:Shinaimm/מנהיג",
	"עץ משפחה לאדם אחד",
	"שופט כדורגל",
	"משתמש:מקף־עברי/יצירה מוזיקלית",
	"יצירת אמנות במרחב הציבורי בישראל בשורה",
	"מחזה קלאסי",
	"חודשים",
	"מיון",
	"מיון/קבוצה",
	"קלייד",
	"אקלים",
	"אתר מורשת בישראל בשורה",
	"אתר מורשת בישראל כותרת",
	"אתר מורשת בישראל סטטי בשורה",
	"אתר מורשת בישראל סטטי כותרת",
	"מספר יישוב",
	"מפלס הכנרת",
	"מפלס ים המלח",
	"מפת מיקום מוויקינתונים",
	"סוג יישוב",
	"פסקת דמוגרפיה",
	"יחסי מדינות",
	"מדינה/אוכלוסייה",
	"מדינה/צפיפות",
	'תמ"ג מדינה',
	"אוניית מעפילים",
	"הנהגה בישראל",
	"מיקום מפורט בישראל",
	"יישוב בישראל",
	"יישוב בישראל/1",
	"Demography 4col",
	"Demography 5col",
	"Demography 6col",
	"Demography 7col",
	"Demography 12col",
	"נתוני שכונות תל אביב",
	"סטטיסטיקה עירונית",
	"עיר תאומה",
	"קיבוץ משולב בבוט היישובים",
	"סוג דגל",
	"סוגיה",
	"פרשת שבוע",
	"ארגונים פוליטיים בולטים המזוהים עם הלאומנים במלחמת האזרחים בספרד",
	"ארגונים פוליטיים בולטים המזוהים עם הרפובליקנים במלחמת האזרחים בספרד",
	"הפיגוע יצא מ",
	"חלוקת כוחות הביטחון בין הצדדים הלוחמים עם פרוץ המלחמה",
	"כלי טיס בחיל האוויר הרפובליקני והלאומני במלחמה",
	"כלי שיט בצי הרפובליקני והלאומני במלחמה",
	"מלחמת האזרחים בסוריה תבנית מידע",
	"מפקד האוכלוסין של ארצות הברית",
	"מקורות המימון העיקריים של הצדדים הלוחמים",
	"ציוד צבאי שנשלח במהלך המלחמה לצדדים הלוחמים",
	"תוצאות הבחירות לפרלמנט בשנות הרפובליקה השנייה",
	'זכויות להט"ב',
	"אגודת סטודנטים",
	"תוכנית לימודים",
	"אנימהמאנגה",
	"סדרת סרטים",
	"סדרת סרטים/סרט",
	"סדרת סרטים/כותרת",
	"סדרת סרטים/ריק",
	"חברות מאיה",
	"שווי שוק חברה בורסאית",
	"שווי שוק חברה בורסאית (ארצות הברית)",
	"אלפבית אורדו",
	"אלפבית דוונאגרי",
	"אלפבית יווני",
	"אלפבית לטיני",
	"אלפבית עברי",
	"אלפבית ערבי",
	"אלפבית קירילי",
	"היראגאנה",
	"סימני פיסוק",
	"קטאקאנה",
	"שורש קאנגשי סיני",
	"תנועות",
	"תעתיק בטורקית",
	"יסוד כימי/טבלה מחזורית/פורמט",
	"Chem2",
	"תא יסוד",
	"כוכב/מרחק/1",
	"מטר מטאורים",
	"נטייה",
	"עלייה ישרה",
	"קבוצת כוכבים",
	"מידע חלקיק",
	"יחידת סלע",
	"גרף מיקומי מצעד",
	"דיסקוגרפיה",
	"דיסקוגרפיה/תיעוד",
	"דירוגים",
	"הכירו את",
	"הצבעת אירוויזיון",
	"הצבעת שופטים-קהל באירוויזיון",
	"כרונולוגיה",
	"להקה צבאית",
	"מיקומי שיא1",
	"מיקומי שיא",
	"ממפ",
	"נתוני מכירות",
	"סולם",
	"סטנדרט",
	"סינגל באלבום",
	"סינגלי אלבום",
	"סינגלים",
	"פילוג הצבעות באירוויזיון",
	"פירוט דיסקוגרפיה",
	"פריט סינגל",
	"קיטלוגים למוזיקה קלאסית שורה",
	"רשימת השמעה",
	"שנה במוזיקה",
	"שנה בפרסי המוזיקה הבריטית",
	"אירוויזיון 1956",
	"אירוויזיון 1957",
	"אירוויזיון 1958",
	"אירוויזיון 1959",
	"אירוויזיון 1960",
	"אירוויזיון 1961",
	"אירוויזיון 1970",
	"אירוויזיון 1998",
	"אירוויזיון 2003",
	"אירוויזיון 2012",
	"אירוויזיון 2013",
	"אירוויזיון 2014",
	"אירוויזיון 2015",
	"אירוויזיון 2016",
	"אירוויזיון 2017",
	"אירוויזיון 2018",
	"אירוויזיון 2019",
	"אירוויזיון 2020",
	"אירוויזיון 2021",
	"אירוויזיון 2022",
	"אירוויזיון 2023",
	"אירוויזיון 2024",
	"אירוויזיון 2025",
	"ערך תזונתי",
	"רשת IRC",
	"ויקיפדיה:יצירה על פי תבנית/בסיס לתבנית פרמטרית",
	"מספר שלם",
	"נתוני גרף",
	"נתוני התפלגות",
	"אמנות לחימה",
	"טורניר גראנד סלאם (טניס)",
	"המכרז האולימפי 2020",
	"טבלת כדורגל",
	"טבלת משחקי גמר של גביע אירופה וליגת האלופות",
	"טורניר טניס ATP",
	"טורניר טניס WTA",
	"טורניר טניס משולב",
	"מדינה במשחקים האולימפיים",
	"מדליות באליפות אירופה באתלטיקה 2022",
	"מדליות באליפות אירופה באתלטיקה 2022/זמן",
	"מדליות באליפות אירופה באתלטיקה 2022/תמצית",
	"מספר מדינות במוקדמות המונדיאל",
	"מקרא תוארי טניס",
	"משחק כדורגל",
	"נבחרת",
	"נבחרת במונדיאל",
	"סגל קבוצת אופניים",
	"סגל קבוצת כדורסל",
	"סופרבול",
	"קבוצות אופניים במרוץ",
	"שחקן כדורסל",
	"שחקן נבחרת",
	"שחקן נבחרת התחלה",
	"שחקן סגל",
	"תוצאות אולימפיאדה",
	"תוצאות משחקי ליגת העל הרוסית בכדורגל 2020/2021",
	"כתב יד",
	"בחירות",
	"בחירות8",
	"בחירות9",
	"בחירות בישראל",
	"בחירות בישראל/מפלגות",
	"בחירות בישראל/ראש ממשלה",
	"רשימה לכנסת",
	"תוצאות בחירות",
	"כוחות מזוינים",
	"יחידה במלחמה",
	"גן",
	"שריר",
	"תבנית מידע/אתר אינטרנט",
	"תבנית מידע/טבלת ניווט",
	"תבנית מידע/לידה ופטירה לאישים",
	"תבנית מידע/מאזן מדליות",
	"תבנית מידע/מפה",
	"תבנית מידע/תלבושת",
	"קרוסאובר בדיוני/פרק",
	"קריירת נהג מרוצים",
	"קריירת רוכב אופנוע",
	"שלב במשגר",
	"תפקיד מנהיג",
	"תפקידים מוויקינתונים",
	"אירוויזיון/קישורים",
	"אירוויזיון/שם",
	"אלבום/רקע",
	"גוף פלנטרי/רקע",
	"דמוגרפיה של מדינה/שם",
	"חברה מסחרית/קטגוריה",
	"כוכב/מילה מספר",
	"כרונולוגיה/סוג ברבים",
	"מפלגה/מדינה בפרלמנט האירופי",
	"מפלגה/מושבים לפי פרלמנט",
	"מפלגה/צבע רקע",
	"משחק/רקע",
	"נבחרת/ענף",
	"סיבוב הופעות/רקע",
	"סינגל/רקע",
	"עיר/סיווג מדינה",
	"עיר/ראש ישות",
	"פעיל ניו מדיה/צבע",
	"פרמטר שם בשפת המקור",
	"קו רכבת/לבן",
	"מעורב באסון תחבורה",
	"קו רכבת/איסטנבול",
	"קו רכבת/אמסטרדם",
	"קו רכבת/אנקרה",
	"קו רכבת/בואנוס איירס",
	"קו רכבת/בודפשט",
	"קו רכבת/ברלין",
	"קו רכבת/גוש דן",
	"קו רכבת/דוחה",
	"קו רכבת/הונג קונג",
	"קו רכבת/וושינגטון",
	"קו רכבת/וינה",
	"קו רכבת/ורשה",
	"קו רכבת/חרקוב",
	"קו רכבת/טביליסי",
	"קו רכבת/טבלה",
	"קו רכבת/ניווט",
	"קו רכבת/טוקיו",
	"קו רכבת/טשקנט",
	"קו רכבת/ירושלים",
	"קו רכבת/לונדון",
	"קו רכבת/מדריד",
	"קו רכבת/מוסקבה",
	"קו רכבת/מקסיקו סיטי",
	"קו רכבת/נובוסיבירסק",
	"קו רכבת/סאו פאולו",
	"קו רכבת/סופיה",
	"קו רכבת/סנקט פטרבורג",
	"קו רכבת/קייב",
	"קו רכבת/צבע",
	"קו רכבת/שנג'ן"]


type Page = {
    title?: string[];
    id?: string[];
    ns?: string[];
    redirect?: any;
    revision?: {
        id?: string[];
        parentid?: string[];
        timestamp?: string[];
        contributor?: {
          username?: string[];
          id?: string[];
        }[];
        comment?: string[];
        origin?: string[];
        model?: string[];
        format?: string[];
        text?: {
          _: string;
          $?: {
            bytes?: string;
            sha1?: string;
            'xml:space'?: string;
          };
        }[];
        sha1?: string[];
    }[];
  };

  async function main() {
    const templatesCount: Record<string, number> = {};
    let pagesCount = 0;

    for (let i = 0; i <= 18; i += 1) {
      const chunk = fs.readFileSync(`./data${i}.xml`, 'utf-8');
      const xml = await parseStringPromise(`<xml>${chunk}</xml>`);
      console.log('Processing chunk', i);
      xml.xml.page.forEach((page: Page) => {
        pagesCount += 1;
        let text = page.revision?.[0]?.text?.[0]?._ || '';
        const title = page.title?.[0] || '';
        const ns = page.ns?.[0] || '';
        if (!text || !title || ns != '0') {
          return;
        }
        for (const templateName of templates) {
          const templates = findTemplates(text, templateName, title);
          if (templates.length > 0) {
            templatesCount[templateName] = (templatesCount[templateName] || 0) + 1;
          }
        }
      });
    console.log('chunk', i, 'done');
  }
   fs.writeFileSync('templatesCount.json', JSON.stringify(templatesCount, null, 2));
   console.log({ pagesCount });
   fs.writeFileSync('pagesCount.txt', Array.from(Object.entries(templatesCount))
   .sort((a, b) => b[1] - a[1])
   .map(([templateName, count]) => `* [[תבנית:${templateName}]]: ${count}`).join('\n'));
}

main();